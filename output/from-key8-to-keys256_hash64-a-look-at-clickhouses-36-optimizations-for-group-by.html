<!DOCTYPE html>
<html lang="fr">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>From key8 to keys256_hash64: A look at ClickHouse's 36+ Optimizations for GROUP BY</title>
                        <link rel="stylesheet" href="/theme/css/main.css" />
    <meta name="description" content="In one of his presentations, Alexey Milovidov, the author of ClickHouse, talks about what makes it so fast. The we have 17 different algorithms..." />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="/">Chekuri</a></h1>
                        <nav><ul>
                                                <li><a href="/pages/about.html">About</a></li>
                                                <li><a href="/pages/srikanths-marriage-doc.html">Srikanth's marriage doc</a></li>
                                                <li class="active"><a href="/category/posts.html">posts</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="/from-key8-to-keys256_hash64-a-look-at-clickhouses-36-optimizations-for-group-by.html" rel="bookmark"
             title="Permalink to From key8 to keys256_hash64: A look at ClickHouse's 36+ Optimizations for GROUP BY">From key8 to keys256_hash64: A look at ClickHouse's 36+ Optimizations for GROUP BY</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-01-01T00:00:00+04:00">
                Published: Mon 01 January 2024
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="/author/chekuri.html">Chekuri</a>
                </address>
        <p>In <a href="/category/posts.html">posts</a>.</p>
<p>tags: <a href="/tag/clickhouse.html">clickhouse</a> </p>        
</footer><!-- /.post-info -->        <p><img src="/images/why-clickhouse-is-so-fast.png" style="float: middle; max-width: 50%; max-height: 300px; height: auto; padding: 0 1em 1em" /></p>
<p>In one of his <a href="https://presentations.clickhouse.com/cern/#40">presentations</a>, Alexey Milovidov, the author of ClickHouse, talks about what makes it so fast. The <strong><em>we have 17 different algorithms for GROUP BY. Best one is selected for your query</em></strong> part caught my attention. I decided to dig deeper and find out what are these 17 algorithms. The presentation is about 7 years old now. Since then, several more optimizations for GROUP BY have been added. At the time of this writing, there are around 36+ optimizations for GROUP BY aggregations. In this post, we will look at 36+ optimizations ClickHouse uses for GROUP BY aggregations.</p>
<p>There are a number of datasets available to work with. Let's load the <em>New York Taxi Data</em> dataset and play with some queries. You can find them <a href="https://clickhouse.com/docs/en/getting-started/example-datasets">here</a>. The schema of the dataset is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nx">CREATE</span><span class="w"> </span><span class="nx">TABLE</span><span class="w"> </span><span class="nx">trips</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">trip_id</span><span class="w">             </span><span class="nx">UInt32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">pickup_datetime</span><span class="w">     </span><span class="nx">DateTime</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dropoff_datetime</span><span class="w">    </span><span class="nx">DateTime</span><span class="p">,</span>
<span class="w">    </span><span class="nx">pickup_longitude</span><span class="w">    </span><span class="nx">Nullable</span><span class="p">(</span><span class="nx">Float64</span><span class="p">),</span>
<span class="w">    </span><span class="nx">pickup_latitude</span><span class="w">     </span><span class="nx">Nullable</span><span class="p">(</span><span class="nx">Float64</span><span class="p">),</span>
<span class="w">    </span><span class="nx">dropoff_longitude</span><span class="w">   </span><span class="nx">Nullable</span><span class="p">(</span><span class="nx">Float64</span><span class="p">),</span>
<span class="w">    </span><span class="nx">dropoff_latitude</span><span class="w">    </span><span class="nx">Nullable</span><span class="p">(</span><span class="nx">Float64</span><span class="p">),</span>
<span class="w">    </span><span class="nx">passenger_count</span><span class="w">     </span><span class="nx">UInt8</span><span class="p">,</span>
<span class="w">    </span><span class="nx">trip_distance</span><span class="w">       </span><span class="nx">Float32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fare_amount</span><span class="w">         </span><span class="nx">Float32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">extra</span><span class="w">               </span><span class="nx">Float32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">tip_amount</span><span class="w">          </span><span class="nx">Float32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">tolls_amount</span><span class="w">        </span><span class="nx">Float32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">total_amount</span><span class="w">        </span><span class="nx">Float32</span><span class="p">,</span>
<span class="w">    </span><span class="nx">payment_type</span><span class="w">        </span><span class="nx">Enum</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">CSH</span><span class="err">&#39;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">CRE</span><span class="err">&#39;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">NOC</span><span class="err">&#39;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">DIS</span><span class="err">&#39;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">UNK</span><span class="err">&#39;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span>
<span class="w">    </span><span class="nx">pickup_ntaname</span><span class="w">      </span><span class="nx">LowCardinality</span><span class="p">(</span><span class="nx">String</span><span class="p">),</span>
<span class="w">    </span><span class="nx">dropoff_ntaname</span><span class="w">     </span><span class="nx">LowCardinality</span><span class="p">(</span><span class="nx">String</span><span class="p">)</span>
<span class="p">)</span>
<span class="nx">ENGINE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">MergeTree</span>
<span class="nx">PRIMARY</span><span class="w"> </span><span class="nx">KEY</span><span class="w"> </span><span class="p">(</span><span class="nx">pickup_datetime</span><span class="p">,</span><span class="w"> </span><span class="nx">dropoff_datetime</span><span class="p">);</span>
</code></pre></div>

<p>We are interested in seeing everything ClickHouse does, so let's change the <code>send_logs_level=trace</code> setting to capture all the logs. In the <code>clickhouse-client</code>, you can run the following command to change the <code>send_logs_level</code> setting to <code>trace</code>:</p>
<div class="highlight"><pre><span></span><code>SET send_logs_level = &#39;trace&#39;
</code></pre></div>

<p>Now, Let's run the query to show the top 10 neighborhoods that have the most frequent pickups.</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">pickup_ntaname</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">trips</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pickup_ntaname</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span>
</code></pre></div>

<p>The following line shows up in the logs:</p>
<div class="highlight"><pre><span></span><code><span class="mi">12</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mf">07.768550</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171191</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d3cace38</span><span class="o">-</span><span class="mi">0</span><span class="n">f4f</span><span class="o">-</span><span class="mi">4</span><span class="n">f02</span><span class="o">-</span><span class="n">bce6</span><span class="o">-</span><span class="mi">142</span><span class="n">ed60501d2</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Aggregator</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregation</span><span class="w"> </span><span class="n">method</span><span class="o">:</span><span class="w"> </span><span class="n">low_cardinality_key_string</span>
</code></pre></div>

<p>Hmm, interesting. It shows that ClickHouse has chosen the <code>low_cardinality_key_string</code> method for the query. What is this method? How does it decide what method to use? How does it affect the performance? So many questions. Come on in fella, we are going to find out.</p>
<p>At the heart of ClickHouse's GROUP BY algorithm is the <a href="https://github.com/ClickHouse/ClickHouse/blob/83c050ad3606521f977ca930e3f33d3347b5b199/src/Interpreters/Aggregator.cpp#L621-L832"><code>chooseAggregationMethod</code></a> function. The function selects the most efficient method for aggregating data. It chooses the most appropriate method based on the number and data type of keys.</p>
<p>Let's break down the function. </p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">/// If no keys. All aggregating to single row.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">without_key</span><span class="p">;</span>
</code></pre></div>

<p>This is the simplest case. If the query does not have a key, it aggregates all the data to a single row.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">/// Check if at least one of the specified keys is nullable.</span>
<span class="w">    </span><span class="n">DataTypes</span><span class="w"> </span><span class="n">types_removed_nullable</span><span class="p">;</span>
<span class="w">    </span><span class="n">types_removed_nullable</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_nullable_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_low_cardinality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">DataTypePtr</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">getByName</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="n">type</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">lowCardinality</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">has_low_cardinality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">removeLowCardinality</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">isNullable</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">has_nullable_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">removeNullable</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">types_removed_nullable</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>This piece of code checks if there are any nullable or low cardinality keys. This is the first hint that ClickHouse uses key's properties to decide what method to use.</p>
<p>Immediately follows the interesting code comment; Let's talk a bit about the two-level thing. </p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="o">/**</span><span class="w"> </span><span class="n">Returns</span><span class="w"> </span><span class="n">ordinary</span><span class="w"> </span><span class="p">(</span><span class="n">not</span><span class="w"> </span><span class="n">two</span><span class="o">-</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="k">methods</span><span class="p">,</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">them</span><span class="p">.</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">Later</span><span class="p">,</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">aggregation</span><span class="w"> </span><span class="n">process</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">converted</span><span class="w"> </span><span class="p">(</span><span class="n">partitioned</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">two</span><span class="o">-</span><span class="n">level</span><span class="w"> </span><span class="n">structure</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cardinality</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">high</span><span class="p">.</span>
<span class="w">      </span><span class="o">*/</span>
</code></pre></div>

<p>When you run the query, you will see the following lines in the logs:</p>
<div class="highlight"><pre><span></span><code><span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.588280</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171191</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">368640</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">172</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.59</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.4114915</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">895862.977</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 25.74 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.588598</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171192</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">368640</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">172</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.63</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.41158325</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">895663.271</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 25.83 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.593291</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1181655</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">362092</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">170</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.44</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.417350792</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">867596.293</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 25.01 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.593991</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171194</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">352256</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">168</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.09</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.417722625</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">843277.282</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 24.16 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.594637</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1179291</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">376832</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">173</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.81</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.418044459</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">901416.086</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 25.85 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.595626</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171186</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">368640</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">172</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.64</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.419871917</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">877982.035</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 25.35 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.597017</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171193</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">360448</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">170</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">10.36</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.420922416</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">856328.830</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 24.62 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
<span class="mi">20</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">42.621890</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">1171187</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">{</span><span class="n">d1b3cb6e</span><span class="o">-</span><span class="n">cbc6</span><span class="o">-</span><span class="mi">488</span><span class="n">b</span><span class="o">-</span><span class="n">bcf8</span><span class="o">-</span><span class="mi">1</span><span class="n">d0eb69b1206</span><span class="o">}</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Trace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AggregatingTransform</span><span class="o">:</span><span class="w"> </span><span class="n">Aggregated</span><span class="o">.</span><span class="w"> </span><span class="mi">442769</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">179</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">(</span><span class="n">from</span><span class="w"> </span><span class="mf">12.77</span><span class="w"> </span><span class="n">MiB</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.445446167</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="w"> </span><span class="o">(</span><span class="mf">993989.920</span><span class="w"> </span><span class="n">rows</span><span class="sr">/sec., 28.66 MiB/s</span><span class="n">ec</span><span class="o">.)</span>
</code></pre></div>

<p>As you might have guessed, ClickHouse launched as many threads as the number of CPU cores. Each thread independently aggregates the part of the data. Now, the intermediary results should be combined to get the final result. This step of combining the results is done sequentially, which is fine for small data sets. But for large data sets, this might be slow. To overcome this, ClickHouse uses the two-level structure. The idea is each thread introduces 256 small hash tables at the first level. The intermediary results combination process is parallelized by bucket number. However, this comes with the cost of additional memory usage. If the group by key doesn't have high unique keys, it's a waste of memory to allocate some thousands of these small hash tables.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_fixed_contiguous_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">key_sizes</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isValueUnambiguouslyRepresentedInContiguousMemoryRegion</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isValueUnambiguouslyRepresentedInFixedSizeContiguousMemoryRegion</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="o">++</span><span class="n">num_fixed_contiguous_keys</span><span class="p">;</span>
<span class="w">                </span><span class="n">key_sizes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getSizeOfValueInMemory</span><span class="p">();</span>
<span class="w">                </span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">key_sizes</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">all_keys_are_numbers_or_strings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isValueRepresentedByNumber</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isFixedString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">all_keys_are_numbers_or_strings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>TODO: Explain</p>
<p>What follows next is a big if/else statement. </p>
<details open>

<summary>Code</summary>


<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_nullable_key</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">/// Optimization for one key</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">has_low_cardinality</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isValueRepresentedByNumber</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_of_field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getSizeOfValueInMemory</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_key8</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_key16</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_key32</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_key64</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isFixedString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_key_fixed_string</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_key_string</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">num_fixed_contiguous_keys</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">has_low_cardinality</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">/// Pack if possible all the keys along with information about which key values are nulls</span>
<span class="w">            </span><span class="c1">/// into a fixed 16- or 32-byte blob.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_size</span><span class="o">&lt;</span><span class="n">KeysNullMap</span><span class="o">&lt;</span><span class="n">UInt128</span><span class="o">&gt;&gt;::</span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_keys128</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_size</span><span class="o">&lt;</span><span class="n">KeysNullMap</span><span class="o">&lt;</span><span class="n">UInt256</span><span class="o">&gt;&gt;::</span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_keys256</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_low_cardinality</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isValueRepresentedByNumber</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_of_field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getSizeOfValueInMemory</span><span class="p">();</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key8</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key16</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key32</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key64</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key_string</span><span class="p">;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isFixedString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key_fixed_string</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">all_keys_are_numbers_or_strings</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_prealloc_serialized</span><span class="p">;</span>

<span class="w">        </span><span class="c1">/// Fallback case.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">nullable_serialized</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">/// No key has been found to be nullable.</span>

<span class="w">    </span><span class="c1">/// Single numeric key.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isValueRepresentedByNumber</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size_of_field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getSizeOfValueInMemory</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_low_cardinality</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key8</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key16</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key32</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key64</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_keys128</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_keys256</span><span class="p">;</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="n">ErrorCodes</span><span class="o">::</span><span class="n">LOGICAL_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LowCardinality numeric column has sizeOfField not in 1, 2, 4, 8, 16, 32.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">key8</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">key16</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">key32</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">key64</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys128</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size_of_field</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys256</span><span class="p">;</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="n">ErrorCodes</span><span class="o">::</span><span class="n">LOGICAL_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Numeric column has sizeOfField not in 1, 2, 4, 8, 16, 32.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isFixedString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_low_cardinality</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key_fixed_string</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">key_fixed_string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">/// If all keys fits in N bits, will use hash table with all keys packed (placed contiguously) to single N-bit key.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">num_fixed_contiguous_keys</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_low_cardinality</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_keys128</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_keys256</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys16</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys32</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys64</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys128</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys_bytes</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">keys256</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">/// If single string key - will use hash table with references to it. Strings itself are stored separately in Arena.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isString</span><span class="p">(</span><span class="n">types_removed_nullable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_low_cardinality</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">low_cardinality_key_string</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">key_string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">keys_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">all_keys_are_numbers_or_strings</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">prealloc_serialized</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AggregatedDataVariants</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">serialized</span><span class="p">;</span>
</code></pre></div>



</details>

<p>You can notice mainly two things in the code. First, when the number of keys = 1, the aggregation method is determined by the size of the key. Second, when the number of keys &gt; 1, the aggregation method is determined by the total size of the keys and if they can be packed into a single N-bit key. Lastly, the fallback case is a serialized method. The <strong><em>serialized</em></strong> method is the slowest among all the methods. So when you write queries, you should keep in mind this detail and if needed, try to re-write the query so that ClickHouse can choose the most efficient method.</p>
<h3>Examples</h3>
<ol>
<li>Column with the same data, different data types</li>
</ol>
<p>Let's create a new column <code>pickup_ntaname_string</code> as a string type but with the same data as <code>pickup_ntaname</code>.</p>
<div class="highlight"><pre><span></span><code>ALTER TABLE datasets.trips ADD COLUMN pickup_ntaname_string String MATERIALIZED toString(pickup_ntaname);
ALTER TABLE datasets.trips MATERIALIZE COLUMN pickup_ntaname_string;
</code></pre></div>

<p>Let's run the query again using the new column.</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">pickup_ntaname_string</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">trips</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pickup_ntaname_string</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span>
</code></pre></div>

<p>Even though the data set is the same, the query is at least twice slower because the selected aggregation method (<strong><em>key_string</em></strong>) is different, which means the hash table used is different. </p>
<ol>
<li>Two low cardinality keys</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">pickup_ntaname</span><span class="p">,</span>
<span class="w">    </span><span class="n">dropoff_ntaname</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">trips</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">pickup_ntaname</span><span class="p">,</span><span class="w"> </span><span class="n">dropoff_ntaname</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span>
</code></pre></div>

<p>Since there is more than one key, ClickHouse checks if the keys can be packed into a single N-bit key. If they can, ClickHouse will use the <strong>_keys{N}</strong> method. If not, ClickHouse will use the <strong><em>prealloc_serialized</em></strong> or <strong><em>serialized</em></strong> method based on the data type of all the keys.</p>
<p>The following query truncates the strings to 16 characters and then groups by the truncated strings to show that the selected method will be <strong><em>keys256</em></strong>.</p>
<div class="highlight"><pre><span></span><code>SELECT
    CAST(left(pickup_ntaname, 16), &#39;FixedString(16)&#39;) as pname,
    CAST(left(dropoff_ntaname, 16), &#39;FixedString(16)&#39;) as dname,
    count(*) AS count
FROM trips
GROUP BY
    pname,
    dname
ORDER BY count DESC
LIMIT 10
</code></pre></div>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>

                                                        <li><a href="https://github.com/srikanthccv">Github</a></li>
                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>